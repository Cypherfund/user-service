version: 2.1
orbs:
  docker: circleci/docker@2.4.0

jobs:
  verify:
    docker:
      - image: ghcr.io/graalvm/jdk:ol8-java17-22.3.1
    steps:
      - checkout
      - run:
          name: Code Verification
          command: ./mvnw verify -DskipTests

  test:
    machine:
      image: ubuntu-2204:2022.04.2
    steps:
      - checkout
      - run:
          name: Start mysql test db
          command: |
            docker images
            docker run -d --name test-db -e MYSQL_ROOT_PASSWORD=testroot -e MYSQL_DATABASE=user-test -p 3306:3306 mysql:latest
      - run:
          name: Run Unit Tests
          command: ./mvnw test
      - store_test_results:
          path: target/surefire-reports

  build_and_push_image:
    machine:
      image: ubuntu-2204:2022.04.2
    steps:
      - checkout
      - setup_remote_docker
      - docker/check:
          docker-password: REGISTRY_PASSWORD
          docker-username: REGISTRY_USER
          registry: ${DOCKER_REGISTRY}
      - run:
          name: Build Image
          command: |
            ./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName=${DOCKER_REGISTRY}/${REGISTRY_USER}/user-service:<< pipeline.number >>_${CIRCLE_SHA1}
      - docker/push:
          image: ${REGISTRY_USER}/user-service
          tag: << pipeline.number >>_${CIRCLE_SHA1}
          registry: ${DOCKER_REGISTRY}

workflows:
  version: 2
  build_and_deploy:
    jobs:
      # - verify
      # - test
      - build_and_push_image
          # requires:
          #   - test
          #   - verify
